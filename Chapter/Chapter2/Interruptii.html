<!DOCTYPE html>
<html lang="en"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Angold-4 Organization</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="../../../images/favicon.png" rel="icon">
<link rel="canonical" href=".">
        <meta name="author" content="Angold Wang" />

    <meta property="og:site_name" content="Angold-4" />
<!--     <meta property="og:type" content="article"/> -->
    <meta property="og:title" content="Angold-4 Organization"/>
    <meta property="og:url" content="."/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="../../../theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="../../../theme/css/font-awesome.min.css" rel="stylesheet">
<!--     <link href="https://cdnjs.cloudflare.com/ajax/libs/typicons/2.0.9/typicons.min.css" rel="stylesheet"> -->

    <link href="../../../theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../theme/css/style.css" type="text/css"/>

  <style>

    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }

    li {
      font-size: 18px;
    }

    p {
      font-size: 18px;
    }

    a {
      font-size: 18px;
    }

    k

    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }

    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }

    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
    {   }

    @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }

    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>

</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script> -->

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://angold4.org" class="navbar-brand">
<img src="../../../images/logo.png" width="32"/> Angold4            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
			    <li><a href="../../../about.html">About</a>
                            <li><a href="../../../blogs.html">Blogs</a>
                            <li><a href="../../../projects.html">Projects</a>

	    </ul>
            <ul class="nav navbar-nav navbar-right">
                <li> <a title="Youtube" href="https://www.youtube.com/channel/UC3ZAjh2LHhm-FrgxgBtgMzQ" target="_new"><i class="fa fa-youtube"></i> Youtube</a>
		</li>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->


<div class="container">
    <div class="row">
        <div class="col-lg-12">
	<section id="content" class="body">
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#operating-systems-design-and-implementation-notes"
id="toc-operating-systems-design-and-implementation-notes">Operating
Systems Design and Implementation Notes</a></li>
<li><a href="#interrupt-inplementation-in-minix3"
id="toc-interrupt-inplementation-in-minix3">Interrupt Inplementation in
Minix3</a>
<ul>
<li><a href="#tss" id="toc-tss">1. TSS</a>
<ul>
<li><a href="#i.-real-mode-vs.-protect-mode"
id="toc-i.-real-mode-vs.-protect-mode">i. Real Mode VS. Protect
Mode</a></li>
<li><a href="#ii.-gdt" id="toc-ii.-gdt">ii. GDT</a></li>
<li><a href="#iii.-tss" id="toc-iii.-tss">iii. TSS</a></li>
</ul></li>
<li><a href="#runtime" id="toc-runtime">2. Runtime</a>
<ul>
<li><a href="#i.-hardware-interrupt" id="toc-i.-hardware-interrupt">i.
Hardware Interrupt</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h2 id="operating-systems-design-and-implementation-notes">Operating
Systems Design and Implementation Notes</h2>
<h1 id="interrupt-inplementation-in-minix3">Interrupt Inplementation in
Minix3</h1>
<h5 id="by-jiawei-wang">By Jiawei Wang</h5>
<p>This note is an extra part of prev <strong><a
href="https://github.com/Angold-4/OSDI/blob/master/Chapter/Chapter2/6Interrupt.md">OSDI
6. Interrupt</a>.</strong><br> <strong>If you want to understand how
MINIX 3 works at the lowest level, perhaps the most important thing is
to understand how exceptions, hardware interrupts, or int <nnn>
instructions lead to the execution of the various pieces of code that
has been written to service them.</strong></p>
<figure>
<img src="Sources/status.png" alt="status" />
<figcaption aria-hidden="true">status</figcaption>
</figure>
<h2 id="tss">1. TSS</h2>
<h3 id="i.-real-mode-vs.-protect-mode">i. Real Mode VS. Protect
Mode</h3>
<h4 id="real-mode">Real Mode</h4>
<ul>
<li><strong>Early Computers, Small Storage</strong></li>
<li><strong>CS:IP -&gt; Physical Address</strong> <br></li>
<li><strong><code>Physical Address = CS &lt;&lt; 4 + IP</code></strong></li>
<li><strong>Security Issue: Hackers can access any part of storiage by
setting CS:IP register</strong></li>
</ul>
<h4 id="protected-mode">Protected Mode</h4>
<ul>
<li><strong>3 Types of Addresses:</strong>
<ul>
<li>Logical Address
<ul>
<li>Used by program</li>
<li><strong>(<code>segment reg(cs, ss, ds...) + offset (ip, sp...)</code>)</strong></li>
</ul></li>
<li>Virtual Address
<ul>
<li>An 32-bit unsigned integer</li>
<li>Represent 4GB address</li>
</ul></li>
<li>Physical Address
<ul>
<li>OS -&gt; Passing to RAM address</li>
</ul></li>
</ul></li>
</ul>
<figure>
<img src="Sources/memoryaddress.png" alt="memoryaddress" />
<figcaption aria-hidden="true">memoryaddress</figcaption>
</figure>
<ol type="1">
<li><strong>Detect Error (Segmentation Error)</strong></li>
<li><strong>Access Large Amount of Memory Effectively</strong></li>
</ol>
<h3 id="ii.-gdt">ii. GDT</h3>
<ul>
<li>Global Descriptor Table.</li>
<li>Each Processor can only have one GDT.</li>
<li>Store the <strong>segment descriptor</strong></li>
</ul>
<h3 id="iii.-tss">iii. TSS</h3>
<ul>
<li>Task State Segment.</li>
<li>TSS Descriptor is Stored in GDT</li>
<li><strong>Key to Understand Interrupt</strong></li>
</ul>
<figure>
<img src="Sources/interrupts.png" alt="interrupts" />
<figcaption aria-hidden="true">interrupts</figcaption>
</figure>
<p><strong>The task-switching mechanism of a 32-bit Intel processor is
complex (handle interrupt).</strong><br> <strong>If you do not
understand the “hidden” work in TSS, it is hard to figure out what
happends.</strong><br></p>
<p>When the CPU receives an interrupt while running a process, it sets
up a <strong>new stack</strong> for use during the interrupt
service.<br> <strong>The location of this stack is determined by an
entry in the Task State Segment (TSS).</strong><br> <strong>The new
stack created by an interrupt always starts at the end of the
<code>stackframe_s</code> structure within the process table entry of
the interrupted process.</strong> <br></p>
<p><strong>The CPU automatically pushes several key registers onto this
new stack</strong>, including those necessary to <strong>reinstate the
interrupted process’ own stack</strong> and <strong>restore its program
counter</strong>. When the interrupt handler code starts running, it
uses this area in the process table as its stack. and much of the
information needed to return to the interrupted process will have
already been stored. <br>The interrupt handler pushes the contents of
additional registers, filling the stackframe, and then switches to a
stack provided by the kernel while it does whatever must be done to
service the interrupt.</p>
<p><strong>Nothing is stored on the interrupted process’ working stack
when a user process is interrupted!</strong></p>
<p><strong>Furthermore, because the stack is created in a known location
(determined by the TSS) after an interrupt, control of multiple
processes is simplified.</strong></p>
<figure>
<img src="Sources/tss.png" alt="tss" />
<figcaption aria-hidden="true">tss</figcaption>
</figure>
<h2 id="runtime">2. Runtime</h2>
<h3 id="i.-hardware-interrupt">i. Hardware Interrupt</h3>
<h5 id="using-clock-interrupt-as-an-hardware-interrupt-example">Using
Clock interrupt as an hardware interrupt example</h5>
<figure>
<img src="Sources/interrupt.png" alt="interrupt" />
<figcaption aria-hidden="true">interrupt</figcaption>
</figure>
<p><strong>Please make sure that you’ve read <a
href="https://github.com/Angold-4/OSDI/blob/master/Chapter/Chapter2/4ClockTick.md">OSDI
4. Inside a Whole Clocktick</a>, to follow the following
contents:</strong></p>
<figure>
<img src="Sources/afterhwi.png" alt="afterhwi" />
<figcaption aria-hidden="true">afterhwi</figcaption>
</figure>
<h4 id="hwint_master"><code>hwint_master</code></h4>
<div class="sourceCode" id="cb1"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>/*===========================================================================*/</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>/*              hwint00 <span class="op">-</span> <span class="dv">07</span>                                               <span class="op">*/</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>/*===========================================================================*/</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>/* Note this is a macro<span class="op">,</span> it just looks like a subroutine<span class="op">.</span> <span class="op">*/</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>#define hwint_master<span class="op">(</span>irq<span class="op">)</span>   <span class="op">\</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    call    save            <span class="op">/*</span> save interrupted process state <span class="op">*/</span><span class="co">;\</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">push</span>    <span class="op">$</span>irq                                <span class="co">;\</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">call</span>    irq_handle      <span class="op">/*</span> irq_handle<span class="op">(</span>irq<span class="op">)</span>        <span class="op">*/</span><span class="co">;\</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">pop</span> <span class="op">%</span><span class="kw">ecx</span>                                <span class="co">;\</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    movb    <span class="op">$</span>END_OF_INT<span class="op">,</span> <span class="op">%</span><span class="kw">al</span>                            <span class="co">;\</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    outb    <span class="op">$</span>INT_CTL            <span class="op">/*</span> reenable master <span class="dv">8259</span>       <span class="op">*/</span><span class="co">;\</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ret</span>             <span class="op">/*</span> restart <span class="op">(</span>another<span class="op">)</span> process      <span class="op">*/</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>/* Each of these entry points is an expansion of the hwint_master macro <span class="op">*/</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>.balign <span class="dv">16</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">hwint00:</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>/* Interrupt routine for irq <span class="dv">0</span> <span class="op">(</span>the clock<span class="op">).</span> <span class="op">*/</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    hwint_master<span class="op">(</span><span class="dv">0</span><span class="op">)</span></span></code></pre></div>
<h4 id="save"><code>save</code></h4>
<div class="sourceCode" id="cb2"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>!*===========================================================================*</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>!*              save                                                       <span class="op">*</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>!*===========================================================================*</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>! Save for protected mode<span class="op">.</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>! This is much simpler than for <span class="dv">8086</span> mode<span class="op">,</span> because the stack already points</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>! <span class="bu">into</span> the process table<span class="op">,</span> <span class="op">or</span> has already been switched to the kernel stack<span class="op">.</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">align</span>  <span class="dv">16</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">save:</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">cld</span>         <span class="op">!</span> set direction flag to a known value</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">pushad</span>          <span class="op">!</span> save <span class="st">&quot;general&quot;</span> registers</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    o16 push    <span class="kw">ds</span>      <span class="op">!</span> save <span class="kw">ds</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    o16 push    <span class="kw">es</span>      <span class="op">!</span> save <span class="kw">es</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    o16 push    <span class="kw">fs</span>      <span class="op">!</span> save <span class="kw">fs</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    o16 push    <span class="kw">gs</span>      <span class="op">!</span> save <span class="kw">gs</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">mov</span> <span class="kw">dx</span><span class="op">,</span> <span class="kw">ss</span>      <span class="op">!</span> <span class="kw">ss</span> is kernel data segment</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">mov</span> <span class="kw">ds</span><span class="op">,</span> <span class="kw">dx</span>      <span class="op">!</span> load rest of kernel segments</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">mov</span> <span class="kw">es</span><span class="op">,</span> <span class="kw">dx</span>      <span class="op">!</span> kernel does <span class="op">not</span> use <span class="kw">fs</span><span class="op">,</span> <span class="kw">gs</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">mov</span> <span class="kw">eax</span><span class="op">,</span> <span class="kw">esp</span>    <span class="op">!</span> prepare to return</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    incb    <span class="op">(</span>_k_reenter<span class="op">)</span>    <span class="op">!</span> from <span class="op">-</span><span class="dv">1</span> if <span class="op">not</span> reentering</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">jnz</span> set_restart1    <span class="op">!</span> stack is already kernel stack</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">mov</span> <span class="kw">esp</span><span class="op">,</span> k_stktop</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">push</span>    _restart    <span class="op">!</span> build return address for int handler</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">xor</span> <span class="kw">ebp</span><span class="op">,</span> <span class="kw">ebp</span>    <span class="op">!</span> for stacktrace</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">jmp</span> RETADR<span class="op">-</span>P_STACKBASE<span class="op">(</span><span class="kw">eax</span><span class="op">)</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">align</span>  <span class="dv">4</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="fu">set_restart1:</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">push</span>    restart1</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">jmp</span> RETADR<span class="op">-</span>P_STACKBASE<span class="op">(</span><span class="kw">eax</span><span class="op">)</span></span></code></pre></div>
<figure>
<img src="Sources/aftersave.png" alt="aftersave" />
<figcaption aria-hidden="true">aftersave</figcaption>
</figure>
<h4 id="restart"><code>restart</code></h4>
<div class="sourceCode" id="cb3"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>!*===========================================================================*</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>!*              restart                                                 <span class="op">*</span>     </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>!*===========================================================================*</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">_restart:</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>! Restart the current process <span class="op">or</span> the next process if it is set<span class="op">.</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">cmp</span> <span class="op">(</span>_next_ptr<span class="op">),</span> <span class="dv">0</span>      <span class="op">!</span> see if another process is scheduled</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">jz</span>  <span class="fl">0</span><span class="bn">f</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">mov</span>     <span class="kw">eax</span><span class="op">,</span> <span class="op">(</span>_next_ptr<span class="op">)</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">mov</span> <span class="op">(</span>_proc_ptr<span class="op">),</span> <span class="kw">eax</span>    <span class="op">!</span> schedule new process </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">mov</span> <span class="op">(</span>_next_ptr<span class="op">),</span> <span class="dv">0</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>0:  <span class="bu">mov</span> <span class="kw">esp</span><span class="op">,</span> <span class="op">(</span>_proc_ptr<span class="op">)</span>    <span class="op">!</span> will assume P_STACKBASE <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">lldt</span>    P_LDT_SEL<span class="op">(</span><span class="kw">esp</span><span class="op">)</span>      <span class="op">!</span> enable process<span class="st">&#39; segment descriptors </span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">lea</span> <span class="kw">eax</span><span class="op">,</span> P_STACKTOP<span class="op">(</span><span class="kw">esp</span><span class="op">)</span>    <span class="op">!</span> arrange for next interrupt</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">mov</span> <span class="op">(</span>_tss<span class="op">+</span>TSS3_S_SP0<span class="op">),</span> <span class="kw">eax</span>  <span class="op">!</span> to save state in process table</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="fu">restart1:</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    decb    <span class="op">(</span>_k_reenter<span class="op">)</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    o16 pop <span class="kw">gs</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    o16 pop <span class="kw">fs</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    o16 pop <span class="kw">es</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    o16 pop <span class="kw">ds</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">popad</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">add</span> <span class="kw">esp</span><span class="op">,</span> <span class="dv">4</span>      <span class="op">!</span> skip return adr</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">iretd</span>           <span class="op">!</span> continue process</span></code></pre></div>
	</section>
	</div>
    </div>

<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
this.page.url = "https://angold4.org/OSDI/Chapter/Chapter2/Interruptii.html"
this.page.identifier = "OSDI/Chapter/Chapter2/Interruptii.html"

    };
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://angold.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>
<footer>
   <div class="well well-lg" id="footer-well">
      <div class="container">


      <div class="row">
         <div class="col-xs-6">
            <a href="https://angold4.org" title="Angold-4 Organization" class="image-link"><img src="../../../images/logo.png" class="cmudb-logo" /></a>
         </div>
         <div class="col-xs-6">
            <p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p>
        </div>
      </div>
   </div>
   </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script src="../../../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="../../../theme/js/respond.min.js"></script>

<!-- Fix scrolling issues to internal HREFs that get positioned behind navbar -->
<!-- http://stackoverflow.com/questions/10732690/offsetting-an-html-anchor-to-adjust-for-fixed-header -->
<script src="../../../theme/js/href_scroll.js"></script>

<!-- You know what this is and you know what he did to me... -->
<script src="../../../theme/js/tim-kraska-betrayed-me.js"></script>
</body>
</html>

